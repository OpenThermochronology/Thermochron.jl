## --- Test creating and allocating a SphericalHe

    tCryst = 3000.0 # Crystallization age [Myr]
    dt = 100        # time step size [Myr]
    r = 29.26       # [μm]
    dr = 1          # [μm]
    U = 33.0        # [ppm]
    Th = 24.2       # [ppm]
    D0 = 0.6071     # [cm^2/s]
    Ea = 122.3      # [kJ/mol]
    stoppingpower = Thermochron.alphastoppingpower("apatite")

    tsteps = (0+dt/2 : dt : tCryst-dt/2)
    Tsteps = collect(range(650, 0, length=length(tsteps)))

    dm = Diffusivity(;D0, Ea)
    SphericalHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @time "Allocating a mineral" mineral = SphericalHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test isa(mineral, SphericalHe)
    show(mineral)
    println()
    display(mineral)

    @test mineral.agesteps == reverse(tsteps)
    @test mineral.r238U ≈ fill(8.349831932773109e16, 29)
    @test mineral.r235U ≈ fill(6.13593691093681e14, 29)
    @test mineral.r232Th ≈ fill(6.281568965517242e16, 29)
    @test mineral.r147Sm ≈ fill(0.0, 29)
    @test mineral.redges == 0:dr:r
    @test mineral.rsteps == (mineral.redges[2:end] + mineral.redges[1:end-1])/2
    @test mineral.nrsteps == length(mineral.rsteps) + 2 # Implicit radius steps inside and outside modeled range

    alphadeposition_known = [2.2867e16 2.2765e16 2.26e16 2.2429e16 2.2305e16 2.2362e16 2.2319e16 2.2071e16 2.1799e16 2.14e16 2.0874e16 2.0356e16 1.9827e16 1.9077e16 1.8257e16 1.7431e16 1.6535e16 1.5681e16 1.4883e16 1.4132e16 1.3421e16 1.2745e16 1.2098e16 1.1478e16 1.088e16 1.0303e16 9.7439e15 9.2006e15 8.6716e15; 2.2037e16 2.1917e16 2.1758e16 2.1599e16 2.1487e16 2.155e16 2.1513e16 2.1281e16 2.1027e16 2.0649e16 2.0143e16 1.9643e16 1.9138e16 1.8413e16 1.7619e16 1.6823e16 1.5957e16 1.5131e16 1.4359e16 1.3634e16 1.2946e16 1.2292e16 1.1667e16 1.1068e16 1.049e16 9.9325e15 9.3923e15 8.8675e15 8.3564e15; 2.1266e16 2.1131e16 2.0977e16 2.0829e16 2.0727e16 2.0795e16 2.0764e16 2.0547e16 2.0309e16 1.995e16 1.9463e16 1.898e16 1.8496e16 1.7796e16 1.7025e16 1.6257e16 1.542e16 1.462e16 1.3873e16 1.317e16 1.2505e16 1.1872e16 1.1267e16 1.0687e16 1.0128e16 9.5884e15 9.0658e15 8.5581e15 8.0638e15; 2.055e16 2.04e16 2.0251e16 2.0114e16 2.002e16 2.0094e16 2.0067e16 1.9864e16 1.9641e16 1.9299e16 1.8829e16 1.8363e16 1.7898e16 1.722e16 1.6472e16 1.573e16 1.4919e16 1.4143e16 1.3419e16 1.2738e16 1.2094e16 1.148e16 1.0894e16 1.0332e16 9.7908e15 9.2682e15 8.762e15 8.2703e15 7.7916e15; 1.9882e16 1.972e16 1.9576e16 1.9448e16 1.9363e16 1.944e16 1.9419e16 1.9227e16 1.9018e16 1.8692e16 1.8238e16 1.7787e16 1.7341e16 1.6683e16 1.5956e16 1.5238e16 1.4452e16 1.3699e16 1.2996e16 1.2336e16 1.171e16 1.1115e16 1.0547e16 1.0002e16 9.4767e15 8.9699e15 8.4791e15 8.0023e15 7.5382e15; 1.9259e16 1.9086e16 1.8947e16 1.8827e16 1.875e16 1.8831e16 1.8813e16 1.8633e16 1.8436e16 1.8125e16 1.7686e16 1.7249e16 1.6819e16 1.6181e16 1.5474e16 1.4779e16 1.4015e16 1.3284e16 1.2601e16 1.196e16 1.1352e16 1.0774e16 1.0223e16 9.6932e15 9.1835e15 8.6915e15 8.215e15 7.7522e15 7.3017e15; 1.8678e16 1.8495e16 1.836e16 1.8247e16 1.8177e16 1.8261e16 1.8247e16 1.8078e16 1.7892e16 1.7594e16 1.7169e16 1.6745e16 1.6331e16 1.5711e16 1.5022e16 1.4349e16 1.3606e16 1.2895e16 1.2232e16 1.1608e16 1.1017e16 1.0456e16 9.9194e15 9.4048e15 8.9095e15 8.4313e15 7.9683e15 7.5186e15 7.0809e15; 1.8133e16 1.7943e16 1.7811e16 1.7705e16 1.7641e16 1.7728e16 1.7718e16 1.7558e16 1.7382e16 1.7096e16 1.6685e16 1.6273e16 1.5873e16 1.527e16 1.4599e16 1.3945e16 1.3223e16 1.2531e16 1.1885e16 1.1278e16 1.0704e16 1.0157e16 9.6353e15 9.1347e15 8.6528e15 8.1877e15 7.7373e15 7.2999e15 6.8742e15; 1.7623e16 1.7425e16 1.7297e16 1.7198e16 1.7139e16 1.7228e16 1.7221e16 1.707e16 1.6903e16 1.6629e16 1.623e16 1.5829e16 1.5443e16 1.4856e16 1.4201e16 1.3566e16 1.2863e16 1.2189e16 1.156e16 1.0969e16 1.0409e16 9.8768e15 9.3688e15 8.8813e15 8.4121e15 7.9592e15 7.5207e15 7.0949e15 6.6805e15; 1.7143e16 1.694e16 1.6815e16 1.6722e16 1.6668e16 1.6759e16 1.6754e16 1.6611e16 1.6453e16 1.619e16 1.5802e16 1.5412e16 1.5038e16 1.4467e16 1.3827e16 1.321e16 1.2525e16 1.1868e16 1.1254e16 1.0678e16 1.0132e16 9.6134e15 9.1183e15 8.6431e15 8.1859e15 7.7446e15 7.3173e15 6.9024e15 6.4986e15; 1.6692e16 1.6485e16 1.6363e16 1.6274e16 1.6225e16 1.6317e16 1.6315e16 1.6179e16 1.603e16 1.5776e16 1.5398e16 1.5019e16 1.4656e16 1.4099e16 1.3475e16 1.2874e16 1.2206e16 1.1564e16 1.0966e16 1.0404e16 9.8716e15 9.3654e15 8.8824e15 8.419e15 7.973e15 7.5426e15 7.1259e15 6.7213e15 6.3275e15; 1.6268e16 1.6056e16 1.5937e16 1.5853e16 1.5808e16 1.5901e16 1.5901e16 1.5772e16 1.563e16 1.5385e16 1.5018e16 1.4647e16 1.4296e16 1.3752e16 1.3142e16 1.2557e16 1.1905e16 1.1278e16 1.0694e16 1.0145e16 9.6256e15 9.1315e15 8.66e15 8.2076e15 7.7723e15 7.3522e15 6.9455e15 6.5507e15 6.1664e15; 1.5867e16 1.5652e16 1.5535e16 1.5455e16 1.5414e16 1.5508e16 1.5511e16 1.5388e16 1.5252e16 1.5016e16 1.4658e16 1.4296e16 1.3955e16 1.3424e16 1.2827e16 1.2257e16 1.162e16 1.1008e16 1.0437e16 9.9008e15 9.3931e15 8.9104e15 8.4498e15 8.0079e15 7.5828e15 7.1724e15 6.7752e15 6.3896e15 6.0143e15; 1.5487e16 1.527e16 1.5156e16 1.508e16 1.5042e16 1.5137e16 1.5141e16 1.5024e16 1.4894e16 1.4666e16 1.4317e16 1.3964e16 1.3632e16 1.3113e16 1.2529e16 1.1972e16 1.135e16 1.0752e16 1.0194e16 9.6694e15 9.173e15 8.7012e15 8.2509e15 7.819e15 7.4034e15 7.0024e15 6.6141e15 6.2373e15 5.8705e15; 1.5128e16 1.4909e16 1.4797e16 1.4725e16 1.469e16 1.4785e16 1.4791e16 1.4679e16 1.4555e16 1.4334e16 1.3993e16 1.3648e16 1.3325e16 1.2818e16 1.2246e16 1.1702e16 1.1094e16 1.0509e16 9.9628e15 9.4498e15 8.9643e15 8.5028e15 8.0624e15 7.6399e15 7.2335e15 6.8412e15 6.4615e15 6.093e15 5.7343e15; 1.4788e16 1.4567e16 1.4457e16 1.4388e16 1.4356e16 1.4452e16 1.4459e16 1.4352e16 1.4233e16 1.4019e16 1.3685e16 1.3348e16 1.3033e16 1.2537e16 1.1977e16 1.1446e16 1.0851e16 1.0278e16 9.7434e15 9.2413e15 8.7661e15 8.3143e15 7.8833e15 7.4699e15 7.0721e15 6.6883e15 6.3167e15 5.9561e15 5.6051e15; 1.4464e16 1.4242e16 1.4134e16 1.4068e16 1.4039e16 1.4135e16 1.4143e16 1.404e16 1.3927e16 1.3718e16 1.3393e16 1.3062e16 1.2756e16 1.227e16 1.1721e16 1.1202e16 1.0619e16 1.0058e16 9.5345e15 9.0428e15 8.5774e15 8.135e15 7.7129e15 7.3081e15 6.9186e15 6.5428e15 6.179e15 5.8259e15 5.4823e15; 1.4155e16 1.3933e16 1.3827e16 1.3764e16 1.3737e16 1.3833e16 1.3842e16 1.3744e16 1.3634e16 1.3432e16 1.3113e16 1.279e16 1.249e16 1.2015e16 1.1477e16 1.0969e16 1.0398e16 9.8481e15 9.3353e15 8.8535e15 8.3976e15 7.9641e15 7.5506e15 7.154e15 6.7724e15 6.4043e15 6.0479e15 5.702e15 5.3654e15; 1.3861e16 1.3639e16 1.3535e16 1.3474e16 1.3449e16 1.3545e16 1.3555e16 1.3461e16 1.3355e16 1.3159e16 1.2846e16 1.253e16 1.2237e16 1.1771e16 1.1243e16 1.0746e16 1.0187e16 9.6478e15 9.1451e15 8.6728e15 8.2259e15 7.801e15 7.3957e15 7.0069e15 6.633e15 6.2721e15 5.9228e15 5.5838e15 5.254e15; 1.358e16 1.3358e16 1.3256e16 1.3198e16 1.3174e16 1.3269e16 1.3281e16 1.319e16 1.3088e16 1.2897e16 1.2591e16 1.2281e16 1.1995e16 1.1538e16 1.102e16 1.0533e16 9.985e15 9.4562e15 8.9632e15 8.5e15 8.0617e15 7.645e15 7.2475e15 6.8664e15 6.4996e15 6.1458e15 5.8033e15 5.4709e15 5.1475e15; 1.3312e16 1.309e16 1.2989e16 1.2933e16 1.2912e16 1.3006e16 1.3018e16 1.2931e16 1.2833e16 1.2646e16 1.2347e16 1.2042e16 1.1762e16 1.1314e16 1.0806e16 1.0329e16 9.7915e15 9.2726e15 8.7889e15 8.3344e15 7.9044e15 7.4956e15 7.1057e15 6.7318e15 6.372e15 6.0249e15 5.689e15 5.3629e15 5.0457e15; 1.3054e16 1.2834e16 1.2734e16 1.268e16 1.266e16 1.2754e16 1.2767e16 1.2683e16 1.2588e16 1.2406e16 1.2112e16 1.1813e16 1.1539e16 1.1099e16 1.0601e16 1.0133e16 9.6057e15 9.0963e15 8.6216e15 8.1756e15 7.7535e15 7.3523e15 6.9697e15 6.6027e15 6.2497e15 5.909e15 5.5794e15 5.2594e15 4.9481e15; 1.2807e16 1.2588e16 1.249e16 1.2437e16 1.2418e16 1.2512e16 1.2525e16 1.2444e16 1.2352e16 1.2174e16 1.1886e16 1.1593e16 1.1325e16 1.0893e16 1.0403e16 9.9444e15 9.4271e15 8.927e15 8.4608e15 8.023e15 7.6086e15 7.2147e15 6.839e15 6.4788e15 6.1322e15 5.7978e15 5.4741e15 5.1601e15 4.8545e15; 1.2569e16 1.2352e16 1.2255e16 1.2204e16 1.2186e16 1.2279e16 1.2293e16 1.2215e16 1.2126e16 1.1952e16 1.1669e16 1.1381e16 1.1118e16 1.0694e16 1.0213e16 9.763e15 9.2551e15 8.764e15 8.3062e15 7.8761e15 7.4691e15 7.0823e15 6.7133e15 6.3596e15 6.0192e15 5.6908e15 5.373e15 5.0646e15 4.7645e15; 1.2341e16 1.2124e16 1.2029e16 1.198e16 1.1963e16 1.2055e16 1.207e16 1.1994e16 1.1907e16 1.1738e16 1.146e16 1.1176e16 1.0919e16 1.0503e16 1.003e16 9.5882e15 9.0894e15 8.6069e15 8.1571e15 7.7346e15 7.3348e15 6.9548e15 6.5923e15 6.2447e15 5.9104e15 5.5878e15 5.2756e15 4.9727e15 4.6779e15; 1.212e16 1.1906e16 1.1812e16 1.1764e16 1.1748e16 1.184e16 1.1854e16 1.1781e16 1.1697e16 1.1531e16 1.1257e16 1.0979e16 1.0726e16 1.0318e16 9.8528e15 9.4194e15 8.9295e15 8.4552e15 8.0133e15 7.5981e15 7.2052e15 6.8317e15 6.4756e15 6.134e15 5.8055e15 5.4885e15 5.1818e15 4.8841e15 4.5944e15; 1.1908e16 1.1695e16 1.1602e16 1.1555e16 1.1541e16 1.1631e16 1.1646e16 1.1575e16 1.1493e16 1.1331e16 1.1062e16 1.0788e16 1.0541e16 1.0139e16 9.6819e15 9.2562e15 8.7749e15 8.3087e15 7.8743e15 7.4662e15 7.08e15 6.7129e15 6.3628e15 6.0271e15 5.7042e15 5.3927e15 5.0911e15 4.7986e15 4.5139e15; 1.1702e16 1.1492e16 1.14e16 1.1354e16 1.134e16 1.143e16 1.1445e16 1.1376e16 1.1297e16 1.1137e16 1.0873e16 1.0604e16 1.0361e16 9.9658e15 9.5164e15 9.0984e15 8.6254e15 8.167e15 7.7398e15 7.3386e15 6.9589e15 6.598e15 6.2538e15 5.9238e15 5.6063e15 5.3e15 5.0036e15 4.7159e15 4.4361e15; 1.1503e16 1.1295e16 1.1204e16 1.116e16 1.1146e16 1.1235e16 1.1251e16 1.1183e16 1.1106e16 1.095e16 1.069e16 1.0425e16 1.0186e16 9.7981e15 9.3562e15 8.9454e15 8.4805e15 8.0297e15 7.6096e15 7.215e15 6.8416e15 6.4867e15 6.1483e15 5.8237e15 5.5115e15 5.2103e15 4.9188e15 4.636e15 4.3608e15; 1.1311e16 1.1104e16 1.1015e16 1.0971e16 1.0959e16 1.1046e16 1.1062e16 1.0997e16 1.0922e16 1.0768e16 1.0513e16 1.0252e16 1.0017e16 9.6355e15 9.2008e15 8.7971e15 8.34e15 7.8966e15 7.4834e15 7.0953e15 6.728e15 6.3789e15 6.046e15 5.7267e15 5.4197e15 5.1234e15 4.8367e15 4.5585e15 4.2879e15]
    @test round.(mineral.alphadeposition, sigdigits=5) ≈ alphadeposition_known
    # println( round.(mineral.alphadeposition, sigdigits=5))

## --- Test integrated age program for SphericalHe

    modelage(mineral,Tsteps,dm) # to not time compilation
    @time "Running modelage" age = modelage(mineral,Tsteps,dm)
    @test age ≈ 86.5695536176058
    # Re-run to ensure internal state does not change
    @test modelage(mineral,Tsteps,dm) ≈ 86.5695536176058
    @test modelage(mineral,Tsteps,dm) ≈ 86.5695536176058

    r = 35.
    U = 110.7
    Th = 35.1
    mineral = SphericalHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 106.0692912497008
    @test modelage(mineral,Tsteps,dm) ≈ 106.0692912497008

    r = 135.
    U = 173.8
    Th = 117.1
    mineral = SphericalHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 222.06332256599651
    @test modelage(mineral,Tsteps,dm) ≈ 222.06332256599651

    r = 135.
    U = 50.0
    Th = 40.0
    mineral = SphericalHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 221.98137127779538
    @test modelage(mineral,Tsteps,dm) ≈ 221.98137127779538

## --- As above but with Sm as well

    r = 35.
    U = 110.7
    Th = 35.1
    Sm = 38.13
    mineral = SphericalHe(age=100, age_sigma=5, r=r,dr=dr,U238=U,Th232=Th,Sm147=Sm,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test mineral.r147Sm ≈ fill(1.56203306122449e17, 35)
    @test modelage(mineral,Tsteps,dm) ≈ 106.19205097501569

## --- Test log likelihood

    @test Thermochron.model_ll(mineral,Tsteps,dm) ≈ -3.295206351182628

## --- Test creating and allocating a PlanarHe

    tCryst = 3000.0 # Crystallization age [Myr]
    dt = 100        # time step size [Myr]
    r = 29.26       # [μm]
    dr = 1          # [μm]
    U = 33.0        # [ppm]
    Th = 24.2       # [ppm]
    D0 = 0.6071     # [cm^2/s]
    Ea = 122.3      # [kJ/mol]
    stoppingpower = Thermochron.alphastoppingpower("apatite")

    tsteps = (0+dt/2 : dt : tCryst-dt/2)
    Tsteps = collect(range(650, 0, length=length(tsteps)))

    dm = Diffusivity(;D0, Ea)
    PlanarHe(;age=175,age_sigma=5,r,dr,U238=U,Th232=Th,stoppingpower,agesteps=reverse(tsteps))
    @time "Allocating a mineral" mineral = PlanarHe(;age=175,age_sigma=5,r,dr,U238=U,Th232=Th,stoppingpower,agesteps=reverse(tsteps))
    @test isa(mineral, PlanarHe)
    show(mineral)
    println()
    display(mineral)

    @test mineral.agesteps == reverse(tsteps)
    @test mineral.r238U ≈ fill(8.349831932773109e16, 29)
    @test mineral.r235U ≈ fill(6.13593691093681e14, 29)
    @test mineral.r232Th ≈ fill(6.281568965517242e16, 29)
    @test mineral.r147Sm ≈ fill(0.0, 29)
    @test mineral.redges == 0:dr:r
    @test mineral.rsteps == (mineral.redges[2:end] + mineral.redges[1:end-1])/2
    @test mineral.nrsteps == length(mineral.rsteps) + 2 # Implicit radius steps inside and outside modeled range

    alphadeposition_known = [2.5851e16 2.585e16 2.5834e16 2.5775e16 2.5706e16 2.5608e16 2.5489e16 2.5318e16 2.513e16 2.4889e16 2.4583e16 2.4255e16 2.3898e16 2.3417e16 2.2867e16 2.2276e16 2.161e16 2.0932e16 2.0253e16 1.9575e16 1.8896e16 1.8218e16 1.7539e16 1.6861e16 1.6182e16 1.5504e16 1.4825e16 1.4147e16 1.3468e16; 2.4875e16 2.4875e16 2.486e16 2.4806e16 2.4742e16 2.465e16 2.4537e16 2.4375e16 2.4197e16 2.3968e16 2.3676e16 2.3361e16 2.302e16 2.2557e16 2.2026e16 2.1458e16 2.0816e16 2.0162e16 1.9507e16 1.8853e16 1.8198e16 1.7544e16 1.6889e16 1.6235e16 1.558e16 1.4926e16 1.4271e16 1.3617e16 1.2962e16; 2.3971e16 2.3971e16 2.3956e16 2.3907e16 2.3848e16 2.3762e16 2.3655e16 2.3501e16 2.3333e16 2.3115e16 2.2834e16 2.2531e16 2.2205e16 2.1759e16 2.1246e16 2.0699e16 2.0079e16 1.9447e16 1.8815e16 1.8183e16 1.7551e16 1.6918e16 1.6286e16 1.5654e16 1.5022e16 1.439e16 1.3758e16 1.3125e16 1.2493e16; 2.3131e16 2.3131e16 2.3117e16 2.3072e16 2.3018e16 2.2936e16 2.2835e16 2.2689e16 2.2529e16 2.2321e16 2.2052e16 2.176e16 2.1448e16 2.1018e16 2.0521e16 1.9993e16 1.9394e16 1.8783e16 1.8172e16 1.756e16 1.6949e16 1.6337e16 1.5726e16 1.5115e16 1.4503e16 1.3892e16 1.328e16 1.2669e16 1.2058e16; 2.2351e16 2.235e16 2.2337e16 2.2296e16 2.2246e16 2.2169e16 2.2072e16 2.1934e16 2.1782e16 2.1583e16 2.1324e16 2.1043e16 2.0743e16 2.0327e16 1.9846e16 1.9336e16 1.8757e16 1.8165e16 1.7573e16 1.6981e16 1.6389e16 1.5797e16 1.5205e16 1.4613e16 1.4021e16 1.3429e16 1.2837e16 1.2245e16 1.1653e16; 2.1624e16 2.1624e16 2.1611e16 2.1573e16 2.1527e16 2.1454e16 2.1362e16 2.123e16 2.1085e16 2.0895e16 2.0645e16 2.0374e16 2.0086e16 1.9683e16 1.9216e16 1.8724e16 1.8163e16 1.7589e16 1.7015e16 1.6441e16 1.5867e16 1.5293e16 1.4719e16 1.4145e16 1.3571e16 1.2997e16 1.2423e16 1.1849e16 1.1275e16; 2.0946e16 2.0946e16 2.0934e16 2.0899e16 2.0856e16 2.0788e16 2.0699e16 2.0573e16 2.0435e16 2.0253e16 2.0012e16 1.975e16 1.9472e16 1.9082e16 1.8629e16 1.8152e16 1.7608e16 1.7051e16 1.6494e16 1.5937e16 1.538e16 1.4823e16 1.4266e16 1.3709e16 1.3152e16 1.2595e16 1.2038e16 1.1481e16 1.0924e16; 2.0313e16 2.0313e16 2.0301e16 2.0269e16 2.023e16 2.0164e16 2.008e16 1.9959e16 1.9827e16 1.9653e16 1.942e16 1.9166e16 1.8898e16 1.852e16 1.8079e16 1.7618e16 1.7089e16 1.6548e16 1.6006e16 1.5465e16 1.4924e16 1.4383e16 1.3842e16 1.3301e16 1.276e16 1.2218e16 1.1677e16 1.1136e16 1.0595e16; 1.972e16 1.972e16 1.9709e16 1.9679e16 1.9643e16 1.9581e16 1.95e16 1.9384e16 1.9258e16 1.909e16 1.8865e16 1.8619e16 1.836e16 1.7993e16 1.7565e16 1.7117e16 1.6603e16 1.6076e16 1.555e16 1.5024e16 1.4498e16 1.3971e16 1.3445e16 1.2919e16 1.2392e16 1.1866e16 1.134e16 1.0814e16 1.0287e16; 1.9165e16 1.9165e16 1.9155e16 1.9127e16 1.9093e16 1.9034e16 1.8957e16 1.8845e16 1.8724e16 1.8563e16 1.8344e16 1.8106e16 1.7856e16 1.7499e16 1.7082e16 1.6646e16 1.6146e16 1.5634e16 1.5122e16 1.461e16 1.4097e16 1.3585e16 1.3073e16 1.256e16 1.2048e16 1.1536e16 1.1024e16 1.0511e16 9.999e15; 1.8644e16 1.8644e16 1.8634e16 1.8608e16 1.8577e16 1.8521e16 1.8446e16 1.8339e16 1.8223e16 1.8067e16 1.7855e16 1.7624e16 1.7381e16 1.7034e16 1.6628e16 1.6205e16 1.5718e16 1.5219e16 1.4719e16 1.422e16 1.3721e16 1.3222e16 1.2723e16 1.2224e16 1.1725e16 1.1226e16 1.0727e16 1.0227e16 9.7283e15; 1.8154e16 1.8154e16 1.8144e16 1.8121e16 1.8091e16 1.8038e16 1.7966e16 1.7863e16 1.7751e16 1.7601e16 1.7395e16 1.717e16 1.6935e16 1.6597e16 1.62e16 1.5788e16 1.5314e16 1.4827e16 1.4341e16 1.3854e16 1.3367e16 1.2881e16 1.2394e16 1.1907e16 1.142e16 1.0934e16 1.0447e16 9.9604e15 9.4737e15; 1.7693e16 1.7692e16 1.7683e16 1.7661e16 1.7634e16 1.7582e16 1.7513e16 1.7414e16 1.7306e16 1.7161e16 1.6961e16 1.6741e16 1.6513e16 1.6184e16 1.5797e16 1.5396e16 1.4933e16 1.4458e16 1.3983e16 1.3508e16 1.3033e16 1.2558e16 1.2083e16 1.1609e16 1.1134e16 1.0659e16 1.0184e16 9.7088e15 9.2338e15; 1.7257e16 1.7257e16 1.7248e16 1.7227e16 1.7202e16 1.7153e16 1.7086e16 1.699e16 1.6886e16 1.6745e16 1.6551e16 1.6337e16 1.6115e16 1.5794e16 1.5416e16 1.5025e16 1.4573e16 1.4109e16 1.3646e16 1.3182e16 1.2718e16 1.2254e16 1.179e16 1.1327e16 1.0863e16 1.0399e16 9.9351e15 9.4713e15 9.0075e15; 1.6845e16 1.6845e16 1.6837e16 1.6817e16 1.6794e16 1.6746e16 1.6682e16 1.6589e16 1.6488e16 1.6352e16 1.6162e16 1.5954e16 1.5739e16 1.5425e16 1.5055e16 1.4674e16 1.4233e16 1.3779e16 1.3326e16 1.2873e16 1.242e16 1.1966e16 1.1513e16 1.106e16 1.0607e16 1.0153e16 9.7e15 9.2467e15 8.7934e15; 1.6456e16 1.6455e16 1.6447e16 1.6429e16 1.6407e16 1.6361e16 1.6299e16 1.6209e16 1.6112e16 1.5979e16 1.5794e16 1.5591e16 1.5381e16 1.5075e16 1.4714e16 1.4341e16 1.391e16 1.3467e16 1.3023e16 1.258e16 1.2137e16 1.1694e16 1.125e16 1.0807e16 1.0364e16 9.9205e15 9.4772e15 9.034e15 8.5907e15; 1.6086e16 1.6086e16 1.6078e16 1.6061e16 1.604e16 1.5996e16 1.5935e16 1.5848e16 1.5754e16 1.5625e16 1.5445e16 1.5246e16 1.5042e16 1.4743e16 1.4389e16 1.4025e16 1.3603e16 1.3169e16 1.2736e16 1.2302e16 1.1868e16 1.1434e16 1.1001e16 1.0567e16 1.0133e16 9.6996e15 9.2659e15 8.8321e15 8.3984e15; 1.5734e16 1.5734e16 1.5726e16 1.5711e16 1.5691e16 1.5649e16 1.559e16 1.5505e16 1.5414e16 1.5289e16 1.5113e16 1.4919e16 1.4719e16 1.4426e16 1.408e16 1.3724e16 1.3311e16 1.2887e16 1.2462e16 1.2037e16 1.1613e16 1.1188e16 1.0763e16 1.0339e16 9.9142e15 9.4896e15 9.0649e15 8.6403e15 8.2156e15; 1.54e16 1.54e16 1.5392e16 1.5377e16 1.5359e16 1.5318e16 1.5261e16 1.5179e16 1.509e16 1.4968e16 1.4796e16 1.4606e16 1.4411e16 1.4125e16 1.3785e16 1.3438e16 1.3033e16 1.2617e16 1.2201e16 1.1785e16 1.1369e16 1.0953e16 1.0537e16 1.0121e16 9.7055e15 9.2895e15 8.8736e15 8.4576e15 8.0416e15; 1.5081e16 1.5081e16 1.5074e16 1.506e16 1.5042e16 1.5002e16 1.4947e16 1.4867e16 1.4781e16 1.4662e16 1.4494e16 1.4308e16 1.4118e16 1.3837e16 1.3504e16 1.3164e16 1.2768e16 1.236e16 1.1952e16 1.1545e16 1.1137e16 1.0729e16 1.0322e16 9.9141e15 9.5064e15 9.0987e15 8.6911e15 8.2834e15 7.8757e15; 1.4777e16 1.4777e16 1.4769e16 1.4756e16 1.474e16 1.4701e16 1.4647e16 1.4569e16 1.4486e16 1.437e16 1.4205e16 1.4023e16 1.3837e16 1.3562e16 1.3236e16 1.2902e16 1.2514e16 1.2114e16 1.1715e16 1.1315e16 1.0915e16 1.0515e16 1.0116e16 9.7159e15 9.3162e15 8.9164e15 8.5167e15 8.117e15 7.7173e15; 1.4486e16 1.4485e16 1.4478e16 1.4466e16 1.445e16 1.4413e16 1.436e16 1.4284e16 1.4203e16 1.409e16 1.3928e16 1.375e16 1.3568e16 1.3298e16 1.2978e16 1.2651e16 1.2271e16 1.1879e16 1.1487e16 1.1095e16 1.0703e16 1.031e16 9.9183e15 9.5262e15 9.1341e15 8.742e15 8.3499e15 7.9578e15 7.5657e15; 1.4207e16 1.4206e16 1.4199e16 1.4188e16 1.4173e16 1.4137e16 1.4085e16 1.4011e16 1.3932e16 1.3821e16 1.3663e16 1.3488e16 1.331e16 1.3045e16 1.2731e16 1.2411e16 1.2038e16 1.1653e16 1.1268e16 1.0883e16 1.0499e16 1.0114e16 9.7291e15 9.3443e15 8.9595e15 8.5747e15 8.19e15 7.8052e15 7.4204e15; 1.3939e16 1.3939e16 1.3932e16 1.3921e16 1.3906e16 1.3871e16 1.3821e16 1.3749e16 1.3671e16 1.3563e16 1.3408e16 1.3237e16 1.3062e16 1.2803e16 1.2494e16 1.218e16 1.1814e16 1.1436e16 1.1058e16 1.0681e16 1.0303e16 9.9252e15 9.5474e15 9.1697e15 8.792e15 8.4142e15 8.0365e15 7.6587e15 7.281e15; 1.3682e16 1.3682e16 1.3675e16 1.3664e16 1.365e16 1.3616e16 1.3567e16 1.3497e16 1.3421e16 1.3315e16 1.3163e16 1.2995e16 1.2824e16 1.2569e16 1.2266e16 1.1958e16 1.1598e16 1.1227e16 1.0857e16 1.0486e16 1.0115e16 9.7437e15 9.3727e15 9.0018e15 8.6308e15 8.2599e15 7.8889e15 7.518e15 7.147e15; 1.3434e16 1.3434e16 1.3427e16 1.3417e16 1.3404e16 1.3371e16 1.3323e16 1.3254e16 1.318e16 1.3077e16 1.2927e16 1.2762e16 1.2594e16 1.2344e16 1.2047e16 1.1744e16 1.1391e16 1.1027e16 1.0662e16 1.0298e16 9.9333e15 9.5689e15 9.2045e15 8.8401e15 8.4757e15 8.1113e15 7.7469e15 7.3825e15 7.0181e15; 1.3196e16 1.3196e16 1.3189e16 1.3179e16 1.3167e16 1.3134e16 1.3087e16 1.302e16 1.2948e16 1.2846e16 1.27e16 1.2537e16 1.2372e16 1.2127e16 1.1835e16 1.1538e16 1.1191e16 1.0833e16 1.0475e16 1.0117e16 9.7584e15 9.4004e15 9.0423e15 8.6842e15 8.3261e15 7.9681e15 7.61e15 7.2519e15 6.8938e15; 1.2966e16 1.2965e16 1.2959e16 1.295e16 1.2938e16 1.2906e16 1.286e16 1.2794e16 1.2723e16 1.2624e16 1.248e16 1.232e16 1.2158e16 1.1917e16 1.163e16 1.1338e16 1.0997e16 1.0645e16 1.0294e16 9.9415e15 9.5896e15 9.2376e15 8.8857e15 8.5337e15 8.1817e15 7.8298e15 7.4778e15 7.1258e15 6.7739e15; 1.2743e16 1.2743e16 1.2737e16 1.2728e16 1.2716e16 1.2685e16 1.264e16 1.2576e16 1.2506e16 1.2409e16 1.2267e16 1.211e16 1.1951e16 1.1714e16 1.1432e16 1.1145e16 1.081e16 1.0464e16 1.0118e16 9.7724e15 9.4263e15 9.0803e15 8.7342e15 8.3882e15 8.0422e15 7.6961e15 7.3501e15 7.004e15 6.658e15; 1.2528e16 1.2528e16 1.2522e16 1.2513e16 1.2502e16 1.2472e16 1.2427e16 1.2364e16 1.2296e16 1.2201e16 1.2061e16 1.1907e16 1.1751e16 1.1518e16 1.124e16 1.0959e16 1.0629e16 1.0289e16 9.9489e15 9.6086e15 9.2683e15 8.928e15 8.5877e15 8.2474e15 7.9071e15 7.5668e15 7.2265e15 6.8862e15 6.5459e15]
    @test round.(mineral.alphadeposition, sigdigits=5) ≈ alphadeposition_known
    # println( round.(mineral.alphadeposition, sigdigits=5))

## --- Test integrated age program for PlanarHe

    modelage(mineral,Tsteps,dm) # to not time compilation
    @time "Running modelage" age = modelage(mineral,Tsteps,dm)
    @test age ≈ 175.45667471971265 
    # Re-run to ensure internal state does not change
    @test modelage(mineral,Tsteps,dm) ≈ 175.45667471971265

    r = 35.
    U = 110.7
    Th = 35.1
    mineral = PlanarHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 191.05626325700732
    @test modelage(mineral,Tsteps,dm) ≈ 191.05626325700732

    r = 135.
    U = 173.8
    Th = 117.1
    mineral = PlanarHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 288.53025435527167
    @test modelage(mineral,Tsteps,dm) ≈ 288.53025435527167

    r = 135.
    U = 50.0
    Th = 40.0
    mineral = PlanarHe(r=r,dr=dr,U238=U,Th232=Th,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test modelage(mineral,Tsteps,dm) ≈ 288.4948166817372
    @test modelage(mineral,Tsteps,dm) ≈ 288.4948166817372

## --- As above but with Sm as well

    r = 35.
    U = 110.7
    Th = 35.1
    Sm = 38.13
    mineral = PlanarHe(age=190, age_sigma=5, r=r,dr=dr,U238=U,Th232=Th,Sm147=Sm,stoppingpower=stoppingpower,agesteps=reverse(tsteps))
    @test mineral.r147Sm ≈ fill(1.56203306122449e17, 35)
    @test modelage(mineral,Tsteps,dm) ≈ 191.1042161796282
    @test modelage(mineral,Tsteps,dm) ≈ 191.1042161796282

## --- Test log likelihood

    @test Thermochron.model_ll(mineral,Tsteps,dm) ≈ -2.552762313065827

## --- End of file