## Test experimentally degassing various chronometers

    tsteps = cntr(0:30:3000)
    Tsteps = collect(range(600, 0, length=length(tsteps)))
    tsteps_degassing = tsteps # but now it's in seconds :p
    Tsteps_degassing = collect(range(0, 700, length=length(tsteps_degassing)))

    dm = Diffusivity(D0=0.6071, Ea=122.3)

    mineral = PlanarHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,stoppingpower=Thermochron.alphastoppingpower("apatite"),tsteps=tsteps)
    @test modelage(mineral, Tsteps, dm) ≈ 207.92412570232977
    total_daughter = nanmean(mineral.y[2:end-1])
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, dm)
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [4.0, 20.0, 60.0, 212.0, 684.0, 2096.0, 6104.0, 16940.0, 45040.0, 114900.0, 282100.0, 667800.0, 1.528e6, 3.387e6, 7.283e6, 1.522e7, 3.095e7, 6.138e7, 1.188e8, 2.247e8, 4.159e8, 7.54e8, 1.341e9, 2.339e9, 4.01e9, 6.758e9, 1.121e10, 1.83e10, 2.945e10, 4.672e10, 7.313e10, 1.13e11, 1.724e11, 2.6e11, 3.877e11, 5.715e11, 8.334e11, 1.202e12, 1.717e12, 2.427e12, 3.393e12, 4.695e12, 6.425e12, 8.691e12, 1.161e13, 1.53e13, 1.988e13, 2.541e13, 3.192e13, 3.939e13, 4.771e13, 5.675e13, 6.64e13, 7.659e13, 8.736e13, 9.881e13, 1.11e14, 1.242e14, 1.383e14, 1.535e14, 1.698e14, 1.874e14, 2.063e14, 2.265e14, 2.482e14, 2.714e14, 2.962e14, 3.226e14, 3.508e14, 3.808e14, 4.127e14, 4.465e14, 4.824e14, 5.204e14, 5.605e14, 6.029e14, 6.477e14, 6.948e14, 7.444e14, 7.965e14, 8.51e14, 9.075e14, 9.651e14, 1.022e15, 1.076e15, 1.122e15, 1.156e15, 1.174e15, 1.172e15, 1.147e15, 1.098e15, 1.025e15, 9.31e14, 8.204e14, 6.992e14, 5.742e14, 4.526e14, 3.41e14, 2.443e14, 3.989e14]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈  [0.0, 8.0, 12.0, 20.0, 136.0, 384.0, 1140.0, 3168.0, 8360.0, 21390.0, 52460.0, 124200.0, 284300.0, 630100.0, 1.355e6, 2.831e6, 5.758e6, 1.142e7, 2.21e7, 4.18e7, 7.737e7, 1.403e8, 2.494e8, 4.351e8, 7.459e8, 1.257e9, 2.085e9, 3.404e9, 5.478e9, 8.692e9, 1.361e10, 2.103e10, 3.209e10, 4.841e10, 7.219e10, 1.065e11, 1.554e11, 2.245e11, 3.21e11, 4.547e11, 6.378e11, 8.864e11, 1.22e12, 1.664e12, 2.248e12, 3.006e12, 3.979e12, 5.212e12, 6.753e12, 8.651e12, 1.096e13, 1.373e13, 1.703e13, 2.092e13, 2.547e13, 3.08e13, 3.699e13, 4.418e13, 5.25e13, 6.209e13, 7.312e13, 8.578e13, 1.002e14, 1.168e14, 1.355e14, 1.568e14, 1.808e14, 2.077e14, 2.377e14, 2.71e14, 3.077e14, 3.48e14, 3.918e14, 4.393e14, 4.904e14, 5.451e14, 6.034e14, 6.652e14, 7.304e14, 7.986e14, 8.695e14, 9.424e14, 1.016e15, 1.088e15, 1.156e15, 1.217e15, 1.266e15, 1.298e15, 1.31e15, 1.298e15, 1.26e15, 1.195e15, 1.106e15, 9.947e14, 8.675e14, 7.313e14, 5.937e14, 4.624e14, 3.439e14, 6.277e14]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 2.688023045019023e16 

    mineral = SphericalHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,stoppingpower=Thermochron.alphastoppingpower("apatite"),tsteps=tsteps)
    @test modelage(mineral, Tsteps, dm) ≈ 128.23220078344227
    total_daughter = nanmean(mineral.y[2:end-1]./mineral.rsteps, mineral.relvolumes)
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, dm)
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [8.0, 32.0, 114.0, 390.0, 1258.0, 3852.0, 11210.0, 31130.0, 82760.0, 211100.0, 518300.0, 1.227e6, 2.808e6, 6.224e6, 1.338e7, 2.796e7, 5.688e7, 1.128e8, 2.183e8, 4.129e8, 7.642e8, 1.386e9, 2.463e9, 4.298e9, 7.368e9, 1.242e10, 2.059e10, 3.363e10, 5.411e10, 8.585e10, 1.344e11, 2.076e11, 3.169e11, 4.778e11, 7.123e11, 1.05e12, 1.531e12, 2.209e12, 3.155e12, 4.458e12, 6.233e12, 8.623e12, 1.18e13, 1.595e13, 2.13e13, 2.806e13, 3.642e13, 4.651e13, 5.837e13, 7.19e13, 8.69e13, 1.031e14, 1.202e14, 1.381e14, 1.568e14, 1.763e14, 1.969e14, 2.186e14, 2.416e14, 2.657e14, 2.91e14, 3.175e14, 3.45e14, 3.736e14, 4.029e14, 4.33e14, 4.634e14, 4.94e14, 5.243e14, 5.54e14, 5.827e14, 6.096e14, 6.343e14, 6.56e14, 6.737e14, 6.867e14, 6.937e14, 6.937e14, 6.851e14, 6.667e14, 6.37e14, 5.95e14, 5.405e14, 4.746e14, 4.004e14, 3.223e14, 2.458e14, 1.764e14, 1.181e14, 7.307e13, 4.134e13, 2.11e13, 9.573e12, 3.782e12, 1.269e12, 3.493e11, 7.493e10, 1.153e10, 1.079e9, 3.6e7]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈ [2.0, 6.0, 24.0, 92.0, 294.0, 874.0, 2566.0, 7128.0, 18950.0, 48340.0, 118700.0, 281000.0, 643000.0, 1.425e6, 3.064e6, 6.403e6, 1.302e7, 2.582e7, 4.998e7, 9.454e7, 1.75e8, 3.172e8, 5.64e8, 9.841e8, 1.687e9, 2.843e9, 4.715e9, 7.7e9, 1.239e10, 1.966e10, 3.077e10, 4.755e10, 7.258e10, 1.095e11, 1.633e11, 2.408e11, 3.514e11, 5.075e11, 7.258e11, 1.028e12, 1.442e12, 2.003e12, 2.757e12, 3.758e12, 5.072e12, 6.777e12, 8.962e12, 1.172e13, 1.516e13, 1.937e13, 2.447e13, 3.056e13, 3.773e13, 4.613e13, 5.588e13, 6.714e13, 8.011e13, 9.498e13, 1.119e14, 1.312e14, 1.531e14, 1.778e14, 2.054e14, 2.363e14, 2.707e14, 3.085e14, 3.499e14, 3.947e14, 4.426e14, 4.93e14, 5.452e14, 5.982e14, 6.508e14, 7.015e14, 7.486e14, 7.903e14, 8.244e14, 8.486e14, 8.606e14, 8.578e14, 8.381e14, 7.999e14, 7.427e14, 6.676e14, 5.779e14, 4.791e14, 3.781e14, 2.821e14, 1.976e14, 1.288e14, 7.741e13, 4.241e13, 2.09e13, 9.114e12, 3.444e12, 1.098e12, 2.844e11, 5.662e10, 7.881e9, 6.418e8]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 1.6465637391602522e16

## --- Import an MDD dataset

    datapath = joinpath("..", "examples", "ol13-mdd.csv")
    mdds = importdataset(datapath, importas=:Tuple)

    agesteps = 995:-10.:5
    tsteps = reverse(agesteps)
    Tsteps = [fill(320., 25); fill(130., 75)]    

## --- Test Multiple Domain Diffusion with with PlanarAr
    mdd = MultipleDomain(Float64, PlanarAr;
        age = mdds.age_Ma,
        age_sigma = mdds.age_sigma_Ma,
        fraction_experimental = mdds.fraction_degassed,
        tsteps_experimental = issorted(mdds.time_s, lt=<=) ? mdds.time_s : cumsum(mdds.time_s),
        Tsteps_experimental = mdds.temperature_C,
        fit = mdds.fit,
        volume_fraction = mdds.volume_fraction[.!isnan.(mdds.volume_fraction)],
        agesteps,
    )
    @test mdd isa MultipleDomain{Float64, <:PlanarAr{Float64}}
    show(mdd)
    println()
    display(mdd)

    tdomains = .!isnan.(mdds.lnD0_a_2)
    dm = MDDiffusivity(
        D0 = (Float64.(exp.(mdds.lnD0_a_2[tdomains]).*(100/10000)^2)...,),
        D0_logsigma = (Float64.(haskey(mdds, :lnD0_a_2_sigma) ? mdds.lnD0_a_2_sigma[tdomains] : fill(log(2)/2, count(tdomains)))...,),
        Ea = (Float64.(mdds.Ea_kJ_mol[tdomains])...,),
        Ea_logsigma = (Float64.(haskey(mdds, :Ea_logsigma) ? mdds.Ea_logsigma[tdomains] : fill(log(2)/2, count(tdomains)))...,),
    )

    age, fraction = modelage(mdd, Tsteps, dm)
    # println(round.(age, sigdigits=5))
    # println(round.(fraction, sigdigits=5))
    @test round.(age, sigdigits=5) == [154.94, 217.94, 289.32, 358.84, 414.61, 460.5, 509.29, 547.24, 583.79, 616.32, 640.09, 662.0, 679.38, 692.71, 705.09, 714.04, 722.54, 729.61, 733.62, 736.62, 738.7, 740.32, 742.11, 743.55, 744.96, 746.07, 746.61, 747.06, 747.81, 749.02, 750.22, 750.56, 750.11, 750.41, 750.53, 749.47, 748.91, 749.65, 750.43, 750.88, 750.97, 751.02, 751.43, 752.13, 752.94, 753.67, 754.36, 754.96, 755.55, 756.07, 756.58, 757.05, 757.53, 757.96, 758.42, 758.84, 759.3, 759.71, 760.17, 760.59, 761.05, 761.47, 761.94, 762.35, 762.82, 763.23, 763.7, 764.11, 764.58, 764.98, 765.45, 765.84, 766.31, 766.69, 767.15, 767.53, 767.99, 768.36, 768.81, 769.17, 769.62, 769.97, 770.43, 770.85, 771.46, 772.1, 772.94, 773.87, 775.02, 776.31, 777.87, 779.73, 781.96, 784.52, 787.62, 791.45, 796.25, 802.46, 810.99, 892.04]
    @test round.(fraction, sigdigits=5) == [0.00017134, 0.00049258, 0.0009698, 0.0015041, 0.0019328, 0.0025828, 0.0032327, 0.0039057, 0.0049035, 0.0057523, 0.0068191, 0.0081277, 0.0092747, 0.010963, 0.012691, 0.014649, 0.01806, 0.020947, 0.024381, 0.028374, 0.031873, 0.0376, 0.043318, 0.049084, 0.057303, 0.063745, 0.071628, 0.082742, 0.097153, 0.11363, 0.1299, 0.14469, 0.15855, 0.17196, 0.18456, 0.1972, 0.21123, 0.22671, 0.24298, 0.25906, 0.27435, 0.28964, 0.30532, 0.32034, 0.33309, 0.34413, 0.35384, 0.36249, 0.3703, 0.3774, 0.38392, 0.38995, 0.39555, 0.4008, 0.40572, 0.41037, 0.41477, 0.41895, 0.42292, 0.42672, 0.43034, 0.43381, 0.43714, 0.44034, 0.44342, 0.44638, 0.44924, 0.45199, 0.45465, 0.45723, 0.45972, 0.46213, 0.46448, 0.46675, 0.46895, 0.47109, 0.47318, 0.4752, 0.47718, 0.4791, 0.48098, 0.48281, 0.48471, 0.48699, 0.48967, 0.49281, 0.49644, 0.5006, 0.5053, 0.51056, 0.51656, 0.52367, 0.53131, 0.53987, 0.54981, 0.56162, 0.57526, 0.59266, 0.61401, 1.0]

    @test Thermochron.model_ll(mdd) ≈ -1174.276593000028

## --- Test Multiple Domain Diffusion with SphericalAr
    mdd = MultipleDomain(Float64, SphericalAr;
        age = mdds.age_Ma,
        age_sigma = mdds.age_sigma_Ma,
        fraction_experimental = mdds.fraction_degassed,
        tsteps_experimental = issorted(mdds.time_s, lt=<=) ? mdds.time_s : cumsum(mdds.time_s),
        Tsteps_experimental = mdds.temperature_C,
        fit = mdds.fit,
        volume_fraction = mdds.volume_fraction[.!isnan.(mdds.volume_fraction)],
        agesteps,
    )
    @test mdd isa MultipleDomain{Float64, <:SphericalAr{Float64}}

    age, fraction = modelage(mdd, Tsteps, dm)
    # println(round.(age, sigdigits=5))
    # println(round.(fraction, sigdigits=5))
    @test round.(age, sigdigits=5) == [146.5, 206.93, 275.91, 343.66, 398.52, 443.89, 492.63, 530.82, 567.9, 601.29, 625.87, 648.75, 667.16, 681.36, 694.79, 704.61, 714.1, 722.43, 727.57, 732.12, 735.92, 738.96, 741.87, 743.52, 744.95, 746.25, 747.28, 748.31, 749.04, 749.08, 749.32, 749.53, 748.93, 748.65, 749.07, 749.46, 749.61, 749.52, 749.69, 750.23, 750.89, 751.46, 751.95, 752.41, 752.95, 753.51, 754.11, 754.63, 755.17, 755.63, 756.11, 756.51, 756.96, 757.33, 757.76, 758.1, 758.53, 758.84, 759.26, 759.56, 759.97, 760.25, 760.66, 760.92, 761.32, 761.56, 761.96, 762.18, 762.58, 762.78, 763.18, 763.36, 763.75, 763.93, 764.32, 764.48, 764.87, 765.01, 765.41, 765.54, 765.93, 766.06, 766.46, 766.65, 767.13, 767.49, 768.1, 768.67, 769.47, 770.3, 771.38, 772.6, 774.13, 775.82, 777.91, 780.4, 783.46, 787.15, 791.71, 809.16]
    @test round.(fraction, sigdigits=5) == [0.00051295, 0.0014691, 0.0028787, 0.0044427, 0.0056867, 0.0075558, 0.0094035, 0.011295, 0.014059, 0.016372, 0.019231, 0.022664, 0.025607, 0.029827, 0.03401, 0.038581, 0.046138, 0.052108, 0.058747, 0.065895, 0.071743, 0.080805, 0.089484, 0.098115, 0.11023, 0.11934, 0.12955, 0.14194, 0.15536, 0.16944, 0.18429, 0.1994, 0.21523, 0.23292, 0.25239, 0.27304, 0.2946, 0.31734, 0.34162, 0.36628, 0.38935, 0.41106, 0.43168, 0.45023, 0.46537, 0.47819, 0.48927, 0.49902, 0.50772, 0.51556, 0.52271, 0.52927, 0.53533, 0.54098, 0.54626, 0.55123, 0.55591, 0.56035, 0.56456, 0.56858, 0.57241, 0.57608, 0.5796, 0.58299, 0.58625, 0.58939, 0.59242, 0.59536, 0.5982, 0.60095, 0.60362, 0.60622, 0.60875, 0.61121, 0.6136, 0.61594, 0.61821, 0.62044, 0.62261, 0.62474, 0.62681, 0.62885, 0.63097, 0.63352, 0.63654, 0.64009, 0.64422, 0.64897, 0.65439, 0.6605, 0.6675, 0.67587, 0.6849, 0.69507, 0.70688, 0.72093, 0.73712, 0.7577, 0.78295, 1.0]

    @test Thermochron.model_ll(mdd) ≈ -1316.160260275503

## --- End of File