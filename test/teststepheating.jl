## Test experimentally degassing various chronometers

    tsteps = cntr(0:30:3000)
    Tsteps = collect(range(600, 0, length=length(tsteps)))
    tsteps_degassing = tsteps # but now it's in seconds :p
    Tsteps_degassing = collect(range(0, 700, length=length(tsteps_degassing)))

    dm = Diffusivity(D0=0.6071, Ea=122.3)

    mineral = PlanarHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,stoppingpower=Thermochron.alphastoppingpower("apatite"),tsteps=tsteps)
    @test modelage(mineral, Tsteps, dm) ≈ 207.92412570232977
    total_daughter = nanmean(mineral.y[2:end-1])
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, dm)
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [4.0, 20.0, 60.0, 212.0, 684.0, 2096.0, 6104.0, 16940.0, 45040.0, 114900.0, 282100.0, 667800.0, 1.528e6, 3.387e6, 7.283e6, 1.522e7, 3.095e7, 6.138e7, 1.188e8, 2.247e8, 4.159e8, 7.54e8, 1.341e9, 2.339e9, 4.01e9, 6.758e9, 1.121e10, 1.83e10, 2.945e10, 4.672e10, 7.313e10, 1.13e11, 1.724e11, 2.6e11, 3.877e11, 5.715e11, 8.334e11, 1.202e12, 1.717e12, 2.427e12, 3.393e12, 4.695e12, 6.425e12, 8.691e12, 1.161e13, 1.53e13, 1.988e13, 2.541e13, 3.192e13, 3.939e13, 4.771e13, 5.675e13, 6.64e13, 7.659e13, 8.736e13, 9.881e13, 1.11e14, 1.242e14, 1.383e14, 1.535e14, 1.698e14, 1.874e14, 2.063e14, 2.265e14, 2.482e14, 2.714e14, 2.962e14, 3.226e14, 3.508e14, 3.808e14, 4.127e14, 4.465e14, 4.824e14, 5.204e14, 5.605e14, 6.029e14, 6.477e14, 6.948e14, 7.444e14, 7.965e14, 8.51e14, 9.075e14, 9.651e14, 1.022e15, 1.076e15, 1.122e15, 1.156e15, 1.174e15, 1.172e15, 1.147e15, 1.098e15, 1.025e15, 9.31e14, 8.204e14, 6.992e14, 5.742e14, 4.526e14, 3.41e14, 2.443e14, 3.989e14]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈  [0.0, 8.0, 12.0, 20.0, 136.0, 384.0, 1140.0, 3168.0, 8360.0, 21390.0, 52460.0, 124200.0, 284300.0, 630100.0, 1.355e6, 2.831e6, 5.758e6, 1.142e7, 2.21e7, 4.18e7, 7.737e7, 1.403e8, 2.494e8, 4.351e8, 7.459e8, 1.257e9, 2.085e9, 3.404e9, 5.478e9, 8.692e9, 1.361e10, 2.103e10, 3.209e10, 4.841e10, 7.219e10, 1.065e11, 1.554e11, 2.245e11, 3.21e11, 4.547e11, 6.378e11, 8.864e11, 1.22e12, 1.664e12, 2.248e12, 3.006e12, 3.979e12, 5.212e12, 6.753e12, 8.651e12, 1.096e13, 1.373e13, 1.703e13, 2.092e13, 2.547e13, 3.08e13, 3.699e13, 4.418e13, 5.25e13, 6.209e13, 7.312e13, 8.578e13, 1.002e14, 1.168e14, 1.355e14, 1.568e14, 1.808e14, 2.077e14, 2.377e14, 2.71e14, 3.077e14, 3.48e14, 3.918e14, 4.393e14, 4.904e14, 5.451e14, 6.034e14, 6.652e14, 7.304e14, 7.986e14, 8.695e14, 9.424e14, 1.016e15, 1.088e15, 1.156e15, 1.217e15, 1.266e15, 1.298e15, 1.31e15, 1.298e15, 1.26e15, 1.195e15, 1.106e15, 9.947e14, 8.675e14, 7.313e14, 5.937e14, 4.624e14, 3.439e14, 6.277e14]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 2.688023045019023e16 

    mineral = PlanarHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,offset=25,stoppingpower=Thermochron.alphastoppingpower("apatite"),tsteps=tsteps)
    @test modelage(mineral, Tsteps, dm) ≈ 99.54227248081155
    total_daughter = nanmean(mineral.y[2:end-1])
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, dm)
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [0.0, 8.0, 30.0, 100.0, 326.0, 992.0, 2896.0, 8036.0, 21360.0, 54500.0, 133800.0, 316800.0, 725000.0, 1.607e6, 3.455e6, 7.219e6, 1.468e7, 2.911e7, 5.635e7, 1.066e8, 1.973e8, 3.577e8, 6.359e8, 1.11e9, 1.902e9, 3.206e9, 5.316e9, 8.681e9, 1.397e10, 2.216e10, 3.469e10, 5.36e10, 8.18e10, 1.234e11, 1.839e11, 2.711e11, 3.953e11, 5.704e11, 8.145e11, 1.151e12, 1.61e12, 2.227e12, 3.048e12, 4.123e12, 5.507e12, 7.259e12, 9.428e12, 1.205e13, 1.514e13, 1.868e13, 2.263e13, 2.692e13, 3.15e13, 3.633e13, 4.144e13, 4.687e13, 5.267e13, 5.89e13, 6.56e13, 7.281e13, 8.057e13, 8.89e13, 9.785e13, 1.075e14, 1.177e14, 1.287e14, 1.405e14, 1.53e14, 1.664e14, 1.806e14, 1.958e14, 2.118e14, 2.288e14, 2.468e14, 2.659e14, 2.86e14, 3.072e14, 3.296e14, 3.531e14, 3.778e14, 4.037e14, 4.305e14, 4.578e14, 4.848e14, 5.102e14, 5.321e14, 5.484e14, 5.569e14, 5.559e14, 5.44e14, 5.207e14, 4.861e14, 4.416e14, 3.892e14, 3.317e14, 2.724e14, 2.147e14, 1.617e14, 1.159e14, 1.892e14]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈  [2.0, 0.0, 2.0, 8.0, 26.0, 80.0, 238.0, 668.0, 1770.0, 4508.0, 11070.0, 26220.0, 59990.0, 132900.0, 285900.0, 597300.0, 1.215e6, 2.409e6, 4.663e6, 8.82e6, 1.632e7, 2.96e7, 5.262e7, 9.181e7, 1.574e8, 2.653e8, 4.399e8, 7.183e8, 1.156e9, 1.834e9, 2.871e9, 4.437e9, 6.773e9, 1.022e10, 1.524e10, 2.249e10, 3.283e10, 4.745e10, 6.793e10, 9.633e10, 1.354e11, 1.886e11, 2.606e11, 3.57e11, 4.853e11, 6.544e11, 8.756e11, 1.163e12, 1.532e12, 2.004e12, 2.603e12, 3.356e12, 4.296e12, 5.461e12, 6.895e12, 8.65e12, 1.078e13, 1.336e13, 1.645e13, 2.014e13, 2.452e13, 2.968e13, 3.574e13, 4.28e13, 5.099e13, 6.043e13, 7.125e13, 8.358e13, 9.754e13, 1.132e14, 1.308e14, 1.503e14, 1.718e14, 1.955e14, 2.212e14, 2.49e14, 2.79e14, 3.11e14, 3.448e14, 3.805e14, 4.175e14, 4.553e14, 4.934e14, 5.305e14, 5.652e14, 5.959e14, 6.204e14, 6.366e14, 6.426e14, 6.367e14, 6.18e14, 5.863e14, 5.423e14, 4.879e14, 4.255e14, 3.587e14, 2.912e14, 2.268e14, 1.687e14, 3.079e14]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 1.2750752884508766e16

    mineral = SphericalHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,stoppingpower=Thermochron.alphastoppingpower("apatite"),tsteps=tsteps)
    @test modelage(mineral, Tsteps, dm) ≈ 128.23220078344227
    total_daughter = nanmean(mineral.y[2:end-1]./mineral.rsteps, mineral.relvolumes)
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, dm)
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [8.0, 32.0, 114.0, 390.0, 1258.0, 3852.0, 11210.0, 31130.0, 82760.0, 211100.0, 518300.0, 1.227e6, 2.808e6, 6.224e6, 1.338e7, 2.796e7, 5.688e7, 1.128e8, 2.183e8, 4.129e8, 7.642e8, 1.386e9, 2.463e9, 4.298e9, 7.368e9, 1.242e10, 2.059e10, 3.363e10, 5.411e10, 8.585e10, 1.344e11, 2.076e11, 3.169e11, 4.778e11, 7.123e11, 1.05e12, 1.531e12, 2.209e12, 3.155e12, 4.458e12, 6.233e12, 8.623e12, 1.18e13, 1.595e13, 2.13e13, 2.806e13, 3.642e13, 4.651e13, 5.837e13, 7.19e13, 8.69e13, 1.031e14, 1.202e14, 1.381e14, 1.568e14, 1.763e14, 1.969e14, 2.186e14, 2.416e14, 2.657e14, 2.91e14, 3.175e14, 3.45e14, 3.736e14, 4.029e14, 4.33e14, 4.634e14, 4.94e14, 5.243e14, 5.54e14, 5.827e14, 6.096e14, 6.343e14, 6.56e14, 6.737e14, 6.867e14, 6.937e14, 6.937e14, 6.851e14, 6.667e14, 6.37e14, 5.95e14, 5.405e14, 4.746e14, 4.004e14, 3.223e14, 2.458e14, 1.764e14, 1.181e14, 7.307e13, 4.134e13, 2.11e13, 9.573e12, 3.782e12, 1.269e12, 3.493e11, 7.493e10, 1.153e10, 1.079e9, 3.6e7]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈ [2.0, 6.0, 24.0, 92.0, 294.0, 874.0, 2566.0, 7128.0, 18950.0, 48340.0, 118700.0, 281000.0, 643000.0, 1.425e6, 3.064e6, 6.403e6, 1.302e7, 2.582e7, 4.998e7, 9.454e7, 1.75e8, 3.172e8, 5.64e8, 9.841e8, 1.687e9, 2.843e9, 4.715e9, 7.7e9, 1.239e10, 1.966e10, 3.077e10, 4.755e10, 7.258e10, 1.095e11, 1.633e11, 2.408e11, 3.514e11, 5.075e11, 7.258e11, 1.028e12, 1.442e12, 2.003e12, 2.757e12, 3.758e12, 5.072e12, 6.777e12, 8.962e12, 1.172e13, 1.516e13, 1.937e13, 2.447e13, 3.056e13, 3.773e13, 4.613e13, 5.588e13, 6.714e13, 8.011e13, 9.498e13, 1.119e14, 1.312e14, 1.531e14, 1.778e14, 2.054e14, 2.363e14, 2.707e14, 3.085e14, 3.499e14, 3.947e14, 4.426e14, 4.93e14, 5.452e14, 5.982e14, 6.508e14, 7.015e14, 7.486e14, 7.903e14, 8.244e14, 8.486e14, 8.606e14, 8.578e14, 8.381e14, 7.999e14, 7.427e14, 6.676e14, 5.779e14, 4.791e14, 3.781e14, 2.821e14, 1.976e14, 1.288e14, 7.741e13, 4.241e13, 2.09e13, 9.114e12, 3.444e12, 1.098e12, 2.844e11, 5.662e10, 7.881e9, 6.418e8]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 1.6465637391602522e16

    mineral = ApatiteHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,tsteps=tsteps)
    Thermochron.anneal!(mineral, Tsteps, RDAAM())
    @test modelage(mineral, Tsteps, RDAAM()) ≈ 321.6472978976417
    total_daughter = nanmean(mineral.y[2:end-1]./mineral.rsteps, mineral.relvolumes)
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, RDAAM())
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 8.0, 8.0, 24.0, 64.0, 152.0, 344.0, 824.0, 1856.0, 4072.0, 8720.0, 18180.0, 37060.0, 73770.0, 143800.0, 274400.0, 513500.0, 943200.0, 1.702e6, 3.017e6, 5.263e6, 9.036e6, 1.528e7, 2.548e7, 4.188e7, 6.794e7, 1.088e8, 1.722e8, 2.692e8, 4.161e8, 6.362e8, 9.625e8, 1.441e9, 2.138e9, 3.141e9, 4.573e9, 6.6e9, 9.444e9, 1.34e10, 1.888e10, 2.638e10, 3.659e10, 5.04e10, 6.893e10, 9.365e10, 1.264e11, 1.696e11, 2.261e11, 2.996e11, 3.948e11, 5.173e11, 6.741e11, 8.739e11, 1.127e12, 1.446e12, 1.846e12, 2.345e12, 2.964e12, 3.73e12, 4.67e12, 5.82e12, 7.219e12, 8.91e12, 1.094e13, 1.337e13, 1.626e13, 1.966e13, 2.364e13, 2.826e13, 3.358e13, 3.964e13, 4.648e13, 5.411e13, 6.252e13, 7.17e13, 8.159e13, 9.212e13, 1.032e14, 1.148e14, 1.268e14, 1.393e14, 1.521e14, 1.653e14, 1.79e14, 1.932e14, 2.079e14, 2.232e14, 2.392e14, 3.951e16]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈ [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 8.0, 0.0, 0.0, 8.0, 32.0, 88.0, 192.0, 424.0, 976.0, 2168.0, 4592.0, 9608.0, 19560.0, 38950.0, 75900.0, 144900.0, 271200.0, 498000.0, 898400.0, 1.593e6, 2.779e6, 4.771e6, 8.069e6, 1.345e7, 2.211e7, 3.587e7, 5.745e7, 9.09e7, 1.421e8, 2.197e8, 3.359e8, 5.082e8, 7.611e8, 1.129e9, 1.658e9, 2.414e9, 3.484e9, 4.986e9, 7.077e9, 9.966e9, 1.393e10, 1.932e10, 2.661e10, 3.639e10, 4.945e10, 6.675e10, 8.953e10, 1.194e11, 1.582e11, 2.085e11, 2.732e11, 3.56e11, 4.615e11, 5.952e11, 7.638e11, 9.752e11, 1.239e12, 1.567e12, 1.972e12, 2.471e12, 3.081e12, 3.823e12, 4.723e12, 5.807e12, 7.106e12, 8.652e12, 1.048e13, 1.263e13, 1.514e13, 1.804e13, 2.138e13, 2.517e13, 2.945e13, 3.422e13, 3.95e13, 4.527e13, 5.153e13, 5.825e13, 6.541e13, 7.3e13, 8.101e13, 8.946e13, 9.836e13, 1.078e14, 1.177e14, 1.283e14, 1.395e14, 1.515e14, 4.053e16]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 4.1992268428047976e16

    mineral = ZirconHe(r=50,dr=1,U238=33.0,Th232=24.2,Sm147=22.0,tsteps=tsteps)
    Thermochron.anneal!(mineral, Tsteps, ZRDAAM())
    @test modelage(mineral, Tsteps, ZRDAAM()) ≈ 592.1423333691473
    total_daughter = nanmean(mineral.y[2:end-1]./mineral.rsteps, mineral.relvolumes)
    step_tracer, step_daughter = Thermochron.degas!(mineral, tsteps_degassing, Tsteps_degassing, ZRDAAM())
    # @info round.(step_tracer, sigdigits=4)
    @test round.(step_tracer, sigdigits=4) ≈ [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 16.0, 16.0, 80.0, 176.0, 448.0, 1056.0, 2400.0, 5376.0, 11700.0, 24750.0, 51250.0, 103600.0, 205000.0, 397400.0, 755000.0, 1.407e6, 2.577e6, 4.635e6, 8.202e6, 1.428e7, 2.45e7, 4.141e7, 6.9e7, 1.135e8, 1.841e8, 2.951e8, 4.674e8, 7.318e8, 1.133e9, 1.735e9, 2.631e9, 3.949e9, 5.871e9, 8.648e9, 1.262e10, 1.827e10, 2.622e10, 3.734e10, 5.274e10, 7.395e10, 1.029e11, 1.422e11, 1.953e11, 2.662e11, 3.607e11, 4.856e11, 6.498e11, 8.644e11, 1.143e12, 1.504e12, 1.967e12, 2.559e12, 3.312e12, 4.264e12, 5.463e12, 6.962e12, 8.83e12, 1.114e13, 1.399e13, 1.747e13, 2.171e13, 2.682e13, 3.296e13, 4.028e13, 4.891e13, 5.901e13, 7.072e13, 8.414e13, 9.935e13, 1.164e14, 1.352e14, 1.557e14, 1.778e14, 2.013e14, 2.26e14, 2.518e14, 2.785e14, 3.063e14, 3.35e14, 3.648e14, 3.959e14, 4.284e14, 4.623e14, 4.979e14, 5.353e14, 7.375e16]
    # @info round.(step_daughter, sigdigits=4)
    @test round.(step_daughter, sigdigits=4) ≈ [0.0, 0.0, 0.0, 16.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 32.0, 0.0, 32.0, 80.0, 192.0, 480.0, 1104.0, 2464.0, 5328.0, 11310.0, 23380.0, 47310.0, 93580.0, 181400.0, 344600.0, 642400.0, 1.176e6, 2.116e6, 3.744e6, 6.52e6, 1.118e7, 1.89e7, 3.15e7, 5.179e7, 8.405e7, 1.347e8, 2.134e8, 3.34e8, 5.172e8, 7.922e8, 1.201e9, 1.803e9, 2.68e9, 3.947e9, 5.763e9, 8.34e9, 1.197e10, 1.704e10, 2.408e10, 3.376e10, 4.698e10, 6.494e10, 8.913e10, 1.215e11, 1.647e11, 2.217e11, 2.966e11, 3.946e11, 5.22e11, 6.866e11, 8.982e11, 1.169e12, 1.513e12, 1.949e12, 2.497e12, 3.184e12, 4.04e12, 5.101e12, 6.41e12, 8.015e12, 9.971e12, 1.234e13, 1.52e13, 1.862e13, 2.268e13, 2.746e13, 3.305e13, 3.954e13, 4.697e13, 5.542e13, 6.493e13, 7.551e13, 8.716e13, 9.988e13, 1.137e14, 1.285e14, 1.444e14, 1.614e14, 1.796e14, 1.991e14, 2.201e14, 2.427e14, 2.671e14, 2.935e14, 3.221e14, 7.627e16]
    @test sum(step_tracer) ≈ sum(step_daughter) ≈ total_daughter ≈ 7.918470224804216e16

## --- Import a single-domain diffusion dataset

    datapath = joinpath("..", "examples", "exampledata", "vis.csv")
    ds = importdataset(datapath, importas=:Tuple)

    datapath = joinpath("..", "examples", "exampledata", "vis-03a.csv")
    sdds = importdataset(datapath, importas=:Tuple)

    agesteps = cntr(450:-2:0.0)
    tsteps = reverse(agesteps)
    Tsteps = [fill(150., 223); fill(10., 2)]

## --- Test Single Domain Diffusion with with ApatiteHe

    Rstep = sdds.He_4_He_3
    Rstep_sigma = sdds.He_4_He_3_sigma
    Rbulk = nanmean(sdds.He_4_He_3, sdds.He_3)
    sdd = SingleDomain(Float64, ApatiteHe;
        step_age = Rstep./Rbulk,
        step_age_sigma = Rstep_sigma./Rbulk,
        fraction_experimental = cumsum(sdds.He_3)./sum(sdds.He_3),
        tsteps_experimental = issorted(sdds.time_s, lt=<=) ? sdds.time_s : cumsum(sdds.time_s),
        Tsteps_experimental = sdds.temperature_C,
        fit = sdds.fit,
        agesteps,
        r = ds.halfwidth_um[19],
        age = ds.raw_He_age_Ma[19],
        age_sigma = ds.raw_He_age_sigma_Ma[19],
        U238 = ds.U238_ppm[19],
        Th232 = ds.Th232_ppm[19],
        Sm147 = ds.Sm147_ppm[19],
    )
    @test sdd isa SingleDomain{Float64, <:ApatiteHe{Float64}}
    show(sdd)
    println()
    display(sdd)

    Thermochron.anneal!(sdd.domain, Tsteps, RDAAM())
    age, stepage, fraction = modelage(sdd, Tsteps, RDAAM())
    @test age ≈ 3.5005457844184718
    # @info round.(stepage, sigdigits=5)
    @test round.(stepage, sigdigits=5) == [0.52263, 0.52342, 0.52429, 0.52527, 0.52635, 0.52755, 0.52887, 0.53032, 0.53191, 0.53364, 0.53552, 0.53754, 0.53972, 0.54201, 0.54431, 0.54656, 0.54876, 0.55091, 0.55302, 0.55508, 0.55709, 0.55907, 0.56099, 0.56288, 0.56473, 0.56655, 0.56833, 0.57008, 0.57181, 0.5735, 0.57518, 0.57684, 0.57847, 0.5801, 0.58171, 0.58331, 0.5849, 0.58648, 0.58806, 0.58964, 0.59121, 0.59278, 0.59435, 0.59593, 0.5975, 0.59909, 0.6007, 0.6024, 0.60419, 0.60608, 0.60805, 0.61013, 0.61231, 0.61459, 0.61698, 0.61948, 0.62209, 0.6248, 0.62756, 0.63035, 0.63317, 0.63601, 0.63889, 0.6418, 0.64475, 0.64774, 0.65076, 0.65383, 0.65693, 0.66007, 0.66324, 0.66646, 0.66971, 0.673, 0.67633, 0.6797, 0.68311, 0.68657, 0.69006, 0.6936, 0.69714, 0.70065, 0.70408, 0.70745, 0.71075, 0.714, 0.71719, 0.72032, 0.7234, 0.72643, 0.7294, 0.73233, 0.7352, 0.73804, 0.74082, 0.74356, 0.74628, 0.74906, 0.75196, 0.75497, 0.7581, 0.76135, 0.76472, 0.76821, 0.77182, 0.77555, 0.7794, 0.78337, 0.78745, 0.79166, 0.79607, 0.80075, 0.80569, 0.8109, 0.81636, 0.82208, 0.82805, 0.83425, 0.84067, 0.84729, 0.8541, 0.861, 0.86781, 0.87438, 0.88073, 0.88687, 0.89281, 0.89856, 0.90412, 0.9095, 0.9147, 0.91975, 0.92463, 0.92936, 0.93394, 0.93836, 0.94263, 0.94676, 0.95076, 0.95462, 0.95836, 0.96198, 0.96548, 0.96887, 0.97214, 0.97531, 0.97838, 0.98135, 0.98425, 0.9871, 0.9899, 0.99265, 0.99533, 0.99796, 1.0005, 1.003, 1.0055, 1.0079, 1.0102, 1.0124, 1.0146, 1.0168, 1.0189, 1.021, 1.0231, 1.0252, 1.0274, 1.0296, 1.0319, 1.0343, 1.0367, 1.0393, 1.042, 1.0448, 1.0477, 1.0509, 1.0542, 1.0578, 1.0615, 1.0654, 1.0695, 1.0739, 1.0786, 1.0835, 1.0887, 1.0942, 1.1, 1.1062, 1.1129, 1.1204, 1.1286, 1.1378, 1.148, 1.1593, 1.1718, 1.1857, 1.2012, 1.2183, 1.2374, 1.2586, 1.2835, 1.3154, 1.3577, 1.4143, 1.491, 1.5977, 1.7527, 1.9958, 2.4401, 3.6547, Inf, 0.0, Inf, 0.0, Inf, 0.0, Inf, 0.0, Inf, 0.0, Inf, 0.0, Inf, 0.0, Inf]
    # @info round.(fraction, sigdigits=5)
    @test round.(fraction, sigdigits=5) == [0.0002322, 0.00049209, 0.00078228, 0.0011055, 0.0014647, 0.0018626, 0.0023025, 0.0027871, 0.0033196, 0.003903, 0.00454, 0.0052335, 0.0059861, 0.006773, 0.0075572, 0.0083387, 0.0091181, 0.0098955, 0.010671, 0.011446, 0.01222, 0.012993, 0.013767, 0.01454, 0.015314, 0.016089, 0.016864, 0.017642, 0.018421, 0.019202, 0.019986, 0.020772, 0.021562, 0.022355, 0.023151, 0.023951, 0.024755, 0.025563, 0.026376, 0.027193, 0.028016, 0.028844, 0.029677, 0.030515, 0.03136, 0.03221, 0.033104, 0.034048, 0.035045, 0.036096, 0.037202, 0.038367, 0.039591, 0.040876, 0.042224, 0.043636, 0.045114, 0.046633, 0.048167, 0.049718, 0.051286, 0.052871, 0.054474, 0.056095, 0.057736, 0.059396, 0.061076, 0.062777, 0.064497, 0.066235, 0.067991, 0.069766, 0.071561, 0.073375, 0.07521, 0.077065, 0.078941, 0.080839, 0.08276, 0.084702, 0.086633, 0.088527, 0.090385, 0.09221, 0.094004, 0.095768, 0.097503, 0.099211, 0.10089, 0.10255, 0.10418, 0.1058, 0.10738, 0.10895, 0.1105, 0.11203, 0.11356, 0.11517, 0.11685, 0.1186, 0.12044, 0.12235, 0.12434, 0.12642, 0.12858, 0.13083, 0.13317, 0.1356, 0.13813, 0.14077, 0.14361, 0.14665, 0.14991, 0.1534, 0.15711, 0.16108, 0.16529, 0.16977, 0.17452, 0.17955, 0.18487, 0.19037, 0.19587, 0.20137, 0.20687, 0.21238, 0.21789, 0.22341, 0.22895, 0.2345, 0.24007, 0.24566, 0.25127, 0.25691, 0.26255, 0.26821, 0.27388, 0.27956, 0.28527, 0.29099, 0.29673, 0.3025, 0.30829, 0.3141, 0.31994, 0.32581, 0.3317, 0.33765, 0.34372, 0.34994, 0.35629, 0.36277, 0.36939, 0.37616, 0.38307, 0.39011, 0.39731, 0.40465, 0.41213, 0.41976, 0.42754, 0.43548, 0.44356, 0.45203, 0.46105, 0.47062, 0.48076, 0.49148, 0.50279, 0.51471, 0.52724, 0.54037, 0.55412, 0.56846, 0.58339, 0.59877, 0.61436, 0.63013, 0.64604, 0.66206, 0.67815, 0.69426, 0.71034, 0.72636, 0.74225, 0.75797, 0.77347, 0.7887, 0.80434, 0.82024, 0.83629, 0.8523, 0.86811, 0.88354, 0.89842, 0.91256, 0.92581, 0.93803, 0.94911, 0.95897, 0.96851, 0.97766, 0.98564, 0.99187, 0.99609, 0.99848, 0.99956, 0.99992, 0.99999, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]

    @test Thermochron.model_ll(sdd) ≈ 6.577102289862751
    @test Thermochron.model_ll(sdd; rescale=true) ≈ 1.6442755724656877

## --- Import a Multiple Domain Diffusion dataset

    datapath = joinpath("..", "examples", "exampledata", "ol13-mdd.csv")
    mdds = importdataset(datapath, importas=:Tuple)

    agesteps = 995:-10.:5
    tsteps = reverse(agesteps)
    Tsteps = [fill(320., 25); fill(130., 75)]

## --- Test Multiple Domain Diffusion with with PlanarAr
    mdd = MultipleDomain(Float64, PlanarAr;
        step_age = mdds.age_Ma,
        step_age_sigma = mdds.age_sigma_Ma,
        fraction_experimental = mdds.fraction_degassed,
        tsteps_experimental = issorted(mdds.time_s, lt=<=) ? mdds.time_s : cumsum(mdds.time_s),
        Tsteps_experimental = mdds.temperature_C,
        fit = mdds.fit,
        volume_fraction = mdds.volume_fraction[.!isnan.(mdds.volume_fraction)],
        agesteps,
    )
    @test mdd isa MultipleDomain{Float64, <:PlanarAr{Float64}}
    show(mdd)
    println()
    display(mdd)

    tdomains = .!isnan.(mdds.lnD0_a_2)
    dm = MDDiffusivity(
        D0 = (Float64.(exp.(mdds.lnD0_a_2[tdomains]).*(100/10000)^2)...,),
        D0_logsigma = (Float64.(haskey(mdds, :lnD0_a_2_sigma) ? mdds.lnD0_a_2_sigma[tdomains] : fill(log(2)/2, count(tdomains)))...,),
        Ea = (Float64.(mdds.Ea_kJ_mol[tdomains])...,),
        Ea_logsigma = (Float64.(haskey(mdds, :Ea_logsigma) ? mdds.Ea_logsigma[tdomains] : fill(log(2)/2, count(tdomains)))...,),
    )

    age, fraction = modelage(mdd, Tsteps, dm)
    # println(round.(age, sigdigits=5))
    # println(round.(fraction, sigdigits=5))
    @test round.(age, sigdigits=5) == [154.94, 217.94, 289.32, 358.84, 414.61, 460.5, 509.29, 547.24, 583.79, 616.32, 640.09, 662.0, 679.38, 692.71, 705.09, 714.04, 722.54, 729.61, 733.62, 736.62, 738.7, 740.32, 742.11, 743.55, 744.96, 746.07, 746.61, 747.06, 747.81, 749.02, 750.22, 750.56, 750.11, 750.41, 750.53, 749.47, 748.91, 749.65, 750.43, 750.88, 750.97, 751.02, 751.43, 752.13, 752.94, 753.67, 754.36, 754.96, 755.55, 756.07, 756.58, 757.05, 757.53, 757.96, 758.42, 758.84, 759.3, 759.71, 760.17, 760.59, 761.05, 761.47, 761.94, 762.35, 762.82, 763.23, 763.7, 764.11, 764.58, 764.98, 765.45, 765.84, 766.31, 766.69, 767.15, 767.53, 767.99, 768.36, 768.81, 769.17, 769.62, 769.97, 770.43, 770.85, 771.46, 772.1, 772.94, 773.87, 775.02, 776.31, 777.87, 779.73, 781.96, 784.52, 787.62, 791.45, 796.25, 802.46, 810.99, 892.04]
    @test round.(fraction, sigdigits=5) == [0.00017134, 0.00049258, 0.0009698, 0.0015041, 0.0019328, 0.0025828, 0.0032327, 0.0039057, 0.0049035, 0.0057523, 0.0068191, 0.0081277, 0.0092747, 0.010963, 0.012691, 0.014649, 0.01806, 0.020947, 0.024381, 0.028374, 0.031873, 0.0376, 0.043318, 0.049084, 0.057303, 0.063745, 0.071628, 0.082742, 0.097153, 0.11363, 0.1299, 0.14469, 0.15855, 0.17196, 0.18456, 0.1972, 0.21123, 0.22671, 0.24298, 0.25906, 0.27435, 0.28964, 0.30532, 0.32034, 0.33309, 0.34413, 0.35384, 0.36249, 0.3703, 0.3774, 0.38392, 0.38995, 0.39555, 0.4008, 0.40572, 0.41037, 0.41477, 0.41895, 0.42292, 0.42672, 0.43034, 0.43381, 0.43714, 0.44034, 0.44342, 0.44638, 0.44924, 0.45199, 0.45465, 0.45723, 0.45972, 0.46213, 0.46448, 0.46675, 0.46895, 0.47109, 0.47318, 0.4752, 0.47718, 0.4791, 0.48098, 0.48281, 0.48471, 0.48699, 0.48967, 0.49281, 0.49644, 0.5006, 0.5053, 0.51056, 0.51656, 0.52367, 0.53131, 0.53987, 0.54981, 0.56162, 0.57526, 0.59266, 0.61401, 1.0]

    @test Thermochron.model_ll(mdd; rescale=true) ≈ -1174.276593000028

## --- Test Multiple Domain Diffusion with SphericalAr
    mdd = MultipleDomain(Float64, SphericalAr;
        step_age = mdds.age_Ma,
        step_age_sigma = mdds.age_sigma_Ma,
        fraction_experimental = mdds.fraction_degassed,
        tsteps_experimental = issorted(mdds.time_s, lt=<=) ? mdds.time_s : cumsum(mdds.time_s),
        Tsteps_experimental = mdds.temperature_C,
        fit = mdds.fit,
        volume_fraction = mdds.volume_fraction[.!isnan.(mdds.volume_fraction)],
        agesteps,
    )
    @test mdd isa MultipleDomain{Float64, <:SphericalAr{Float64}}

    age, fraction = modelage(mdd, Tsteps, dm)
    # println(round.(age, sigdigits=5))
    # println(round.(fraction, sigdigits=5))
    @test round.(age, sigdigits=5) == [146.5, 206.93, 275.91, 343.66, 398.52, 443.89, 492.63, 530.82, 567.9, 601.29, 625.87, 648.75, 667.16, 681.36, 694.79, 704.61, 714.1, 722.43, 727.57, 732.12, 735.92, 738.96, 741.87, 743.52, 744.95, 746.25, 747.28, 748.31, 749.04, 749.08, 749.32, 749.53, 748.93, 748.65, 749.07, 749.46, 749.61, 749.52, 749.69, 750.23, 750.89, 751.46, 751.95, 752.41, 752.95, 753.51, 754.11, 754.63, 755.17, 755.63, 756.11, 756.51, 756.96, 757.33, 757.76, 758.1, 758.53, 758.84, 759.26, 759.56, 759.97, 760.25, 760.66, 760.92, 761.32, 761.56, 761.96, 762.18, 762.58, 762.78, 763.18, 763.36, 763.75, 763.93, 764.32, 764.48, 764.87, 765.01, 765.41, 765.54, 765.93, 766.06, 766.46, 766.65, 767.13, 767.49, 768.1, 768.67, 769.47, 770.3, 771.38, 772.6, 774.13, 775.82, 777.91, 780.4, 783.46, 787.15, 791.71, 809.16]
    @test round.(fraction, sigdigits=5) == [0.00051295, 0.0014691, 0.0028787, 0.0044427, 0.0056867, 0.0075558, 0.0094035, 0.011295, 0.014059, 0.016372, 0.019231, 0.022664, 0.025607, 0.029827, 0.03401, 0.038581, 0.046138, 0.052108, 0.058747, 0.065895, 0.071743, 0.080805, 0.089484, 0.098115, 0.11023, 0.11934, 0.12955, 0.14194, 0.15536, 0.16944, 0.18429, 0.1994, 0.21523, 0.23292, 0.25239, 0.27304, 0.2946, 0.31734, 0.34162, 0.36628, 0.38935, 0.41106, 0.43168, 0.45023, 0.46537, 0.47819, 0.48927, 0.49902, 0.50772, 0.51556, 0.52271, 0.52927, 0.53533, 0.54098, 0.54626, 0.55123, 0.55591, 0.56035, 0.56456, 0.56858, 0.57241, 0.57608, 0.5796, 0.58299, 0.58625, 0.58939, 0.59242, 0.59536, 0.5982, 0.60095, 0.60362, 0.60622, 0.60875, 0.61121, 0.6136, 0.61594, 0.61821, 0.62044, 0.62261, 0.62474, 0.62681, 0.62885, 0.63097, 0.63352, 0.63654, 0.64009, 0.64422, 0.64897, 0.65439, 0.6605, 0.6675, 0.67587, 0.6849, 0.69507, 0.70688, 0.72093, 0.73712, 0.7577, 0.78295, 1.0]

    @test Thermochron.model_ll(mdd; rescale=true) ≈ -1316.160260275503

## --- End of File