datapath = joinpath("..", "examples", "ol13.csv")
ds = importdataset(datapath, importas=:Tuple)

agesteps = 995:-10.:5
tsteps = reverse(agesteps)
Tsteps = range(250, 0., length(tsteps))

mdd = MultipleDomain(;
    age = ds.age_Ma,
    age_sigma = ds.age_sigma_Ma,
    fraction_released = ds.fraction_degassed,
    tsteps_experimental = issorted(ds.time_s, lt=<=) ? ds.time_s : cumsum(ds.time_s),
    Tsteps_experimental = ds.temperature_C,
    fit = ds.fit,
    volume_fraction = ds.volume_fraction[.!isnan.(ds.volume_fraction)],
    lnD0_a_2 = ds.lnD0_a_2[.!isnan.(ds.lnD0_a_2)],
    Ea = ds.Ea_kJ_mol[.!isnan.(ds.Ea_kJ_mol)],
    agesteps,
)
@test mdd isa MultipleDomain{Float64, PlanarAr{Float64}}

age, fraction = modelage(mdd, Tsteps)
# println(round.(age, sigdigits=5))
@test round.(age, sigdigits=5) == [510.83, 511.8, 513.93, 517.33, 521.11, 525.62, 531.16, 536.52, 542.51, 548.57, 553.88, 559.77, 565.37, 571.05, 577.48, 583.71, 591.55, 600.18, 607.38, 614.92, 621.85, 629.16, 637.73, 645.49, 654.02, 662.75, 670.2, 679.01, 689.42, 700.5, 711.32, 721.37, 731.44, 743.4, 757.92, 772.54, 783.25, 790.3, 797.94, 808.53, 821.75, 835.78, 848.56, 859.09, 867.76, 875.46, 882.78, 889.64, 895.97, 901.63, 906.64, 910.93, 914.64, 917.76, 920.45, 922.69, 924.67, 926.33, 927.85, 929.14, 930.37, 931.43, 932.47, 933.38, 934.31, 935.14, 935.99, 936.75, 937.56, 938.27, 939.05, 939.73, 940.47, 941.13, 941.85, 942.49, 943.19, 943.82, 944.5, 945.1, 945.77, 946.36, 947.03, 947.73, 948.62, 949.64, 950.88, 952.3, 953.98, 955.88, 958.06, 960.58, 963.4, 966.36, 969.5, 972.75, 975.91, 978.83, 981.57, 984.08]
# println(round.(fraction, sigdigits=5))
@test round.(fraction, sigdigits=5) == [1.0504e-5, 3.9141e-5, 9.7686e-5, 0.00018135, 0.00026017, 0.00039391, 0.00054264, 0.00070869, 0.0009729, 0.0012123, 0.0015281, 0.0019339, 0.0023034, 0.0028638, 0.0034541, 0.0041365, 0.00535, 0.006395, 0.0076538, 0.0091381, 0.010463, 0.012705, 0.015073, 0.017637, 0.021635, 0.025065, 0.029516, 0.036139, 0.045441, 0.05794, 0.07418, 0.094629, 0.11928, 0.1473, 0.17764, 0.21032, 0.24655, 0.28682, 0.32911, 0.36873, 0.40217, 0.43096, 0.45678, 0.47929, 0.49727, 0.51217, 0.52482, 0.53579, 0.54547, 0.55417, 0.56209, 0.56941, 0.57623, 0.58265, 0.58873, 0.59453, 0.60008, 0.60542, 0.61057, 0.61555, 0.62037, 0.62505, 0.6296, 0.63402, 0.63832, 0.64252, 0.64661, 0.65061, 0.6545, 0.65831, 0.66204, 0.66568, 0.66924, 0.67272, 0.67613, 0.67948, 0.68275, 0.68596, 0.6891, 0.69219, 0.69521, 0.69818, 0.7013, 0.70503, 0.70948, 0.71472, 0.72083, 0.7279, 0.73598, 0.74513, 0.75566, 0.76831, 0.78209, 0.79776, 0.81626, 0.8388, 0.86566, 0.90138, 0.94758, 1.0]